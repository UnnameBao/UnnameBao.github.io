{"title":"ThinkPHPç³»åˆ—â€”â€”æ§åˆ¶å™¨è¿‡æ»¤ä¸ä¸¥å¯¼è‡´RCEè°ƒè¯•åŠè¯¦ç»†åˆ†æ","slug":"thinkphp1","date":"2021-03-09T01:28:51.000Z","updated":"2021-03-09T06:25:27.853Z","comments":true,"path":"api/articles/thinkphp1.json","photos":[],"link":"","excerpt":" å‰è¨€ThinkPHPæ˜¯è®¸å¤šä¸­å°å‹ä¼ä¸šç”¨äºç½‘ç«™å¼€å‘çš„å›½äº§cmsï¼Œåœ¨2019å¹´å‡ºç°è¿‡å¤šä¸ªRCEï¼Œæœ¬äººæ­¤å‰æ²¡æœ‰è¿‡åŠ¨æ€è°ƒè¯•PHPä»£ç çš„ç»éªŒï¼Œåœ¨æœ¬æ–‡ä¸­è®°å½•é…ç½®å’Œä½¿ç”¨è¿‡ç¨‹ä¾›å¤§å®¶å­¦ä¹ å‚è€ƒã€‚æœ¬æ–‡æ‰€æœ‰ç¯å¢ƒäºArchLinuxç³»ç»Ÿæ­å»ºï¼Œå…¶ä»–ç³»ç»Ÿé…ç½®æ–¹æ³•å¤§åŒå°å¼‚ã€‚","covers":["../static/images/image-20210309095347435.png","../static/images/image-20210309095521032.png","../static/images/image-20210309095603856.png","../static/images/image-20210309095626043.png","../static/images/image-20210309095639471.png","../static/images/image-20210309095822596.png","../static/images/image-20210309095900514.png","../static/images/image-20210309095929909.png","../static/images/image-20210309104235268.png","../static/images/image-20210309101330291.png","../static/images/image-20210309102136758.png","../static/images/image-20210309102153169.png","../static/images/image-20210309112648259.png","../static/images/image-20210309113148298.png","../static/images/image-20210309113648190.png","../static/images/image-20210309114205321.png","../static/images/image-20210309114944995.png","../static/images/image-20210309115346300.png","../static/images/image-20210309115507308.png","../static/images/image-20210309120040834.png","../static/images/image-20210309115903673.png"],"content":"<h1 id=\"å‰è¨€\"><a class=\"markdownIt-Anchor\" href=\"#å‰è¨€\"></a> å‰è¨€</h1>\n<p>ThinkPHPæ˜¯è®¸å¤šä¸­å°å‹ä¼ä¸šç”¨äºç½‘ç«™å¼€å‘çš„å›½äº§cmsï¼Œåœ¨2019å¹´å‡ºç°è¿‡å¤šä¸ªRCEï¼Œæœ¬äººæ­¤å‰æ²¡æœ‰è¿‡åŠ¨æ€è°ƒè¯•PHPä»£ç çš„ç»éªŒï¼Œåœ¨æœ¬æ–‡ä¸­è®°å½•é…ç½®å’Œä½¿ç”¨è¿‡ç¨‹ä¾›å¤§å®¶å­¦ä¹ å‚è€ƒã€‚</p>\n<p>æœ¬æ–‡æ‰€æœ‰ç¯å¢ƒäºArchLinuxç³»ç»Ÿæ­å»ºï¼Œå…¶ä»–ç³»ç»Ÿé…ç½®æ–¹æ³•å¤§åŒå°å¼‚ã€‚</p>\n<span id=\"more\"></span>\n<h1 id=\"é…ç½®nginx-php-73-phpstorm-xdebug-è¿›è¡Œæºç è°ƒè¯•\"><a class=\"markdownIt-Anchor\" href=\"#é…ç½®nginx-php-73-phpstorm-xdebug-è¿›è¡Œæºç è°ƒè¯•\"></a> é…ç½®Nginx + PHP 7.3 + PHPStorm + Xdebug è¿›è¡Œæºç è°ƒè¯•</h1>\n<p>æœ¬ç« å°†ä»‹ç»å¦‚ä½•é…ç½®è°ƒè¯•ç¯å¢ƒï¼Œå¦‚æœå·²ç»å…·å¤‡è¯¥æ¡ä»¶çš„è¯·è‡ªè¡Œè·³è¿‡ã€‚å®‰è£…php 7.3ç¯å¢ƒï¼ˆphp 8.xä»¥ä¸Šå¼ƒç”¨äº†getClasså‡½æ•°ï¼Œå¤ç°è¿‡ç¨‹ä¼šå‡ºé—®é¢˜ï¼‰ï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ALL_PROXY&#x3D;socks5:&#x2F;&#x2F;127.0.0.1:10808 yay -S php73 php73-fpm aur&#x2F;php73-xdebug #ç”±äºå›½å†…ç½‘ç»œç¯å¢ƒé—®é¢˜é…ç½®äº†ä»£ç†</span><br></pre></td></tr></table></figure>\n<p>ä¿®æ”¹æ–‡ä»¶/etc/php73/conf.d/xdebug.ini ï¼ˆæ²¡æœ‰å°±å»ºä¸€ä¸ªï¼‰ï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">zend_extension&#x3D;&#x2F;lib&#x2F;php73&#x2F;modules&#x2F;xdebug.so</span><br><span class=\"line\">xdebug.remote_enable&#x3D;on</span><br><span class=\"line\">xdebug.remote_host&#x3D;127.0.0.1</span><br><span class=\"line\">xdebug.remote_port&#x3D;9000</span><br><span class=\"line\">xdebug.client_port&#x3D;9003</span><br><span class=\"line\">xdebug.remote_handler &#x3D; &quot;dbgp&quot;</span><br><span class=\"line\">xdebug.idekey &#x3D; PHPSTORM</span><br><span class=\"line\">xdebug.auto_trace&#x3D;1</span><br><span class=\"line\">xdebug.collect_params&#x3D;1</span><br><span class=\"line\">xdebug.collect_return&#x3D;1</span><br><span class=\"line\">xdebug.profiler_enable &#x3D; 1</span><br><span class=\"line\">xdebug.profiler_output_name &#x3D; &quot;cachegrind.out.%t.%p&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>ä¿®æ”¹/etc/php73/php.iniï¼Œéšä¾¿åœ¨å¼€å¤´åŠ ä¸€è¡Œï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xdebug.mode&#x3D;debug</span><br></pre></td></tr></table></figure>\n<p>ä¿®æ”¹/etc/php73/php-fpm.d/www.conf,æ·»åŠ ä¸€è¡Œï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen &#x3D; 127.0.0.1:9001 </span><br></pre></td></tr></table></figure>\n<p>ä¿®æ”¹/etc/nginx/nginx.confä¸­å¯¹åº”çš„éƒ¨åˆ†ï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   location ~ \\.php$ &#123;</span><br><span class=\"line\">        try_files $uri &#x3D;404;</span><br><span class=\"line\"></span><br><span class=\"line\">        include fastcgi.conf;</span><br><span class=\"line\">        fastcgi_pass 127.0.0.1:9001;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ­¤<a href=\"http://www.thinkphp.cn/download/1260.html\">é¡µé¢</a>ä¸‹è½½thinkphp 5.2æºç ï¼Œç„¶åè§£å‹è‡³/usr/share/nginx/htmlï¼Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">share&#x2F;nginx&#x2F;html via ğŸ˜ </span><br><span class=\"line\">â¯ ls </span><br><span class=\"line\">application&#x2F;  build.php*  composer.json*  composer.lock*  extend&#x2F;  LICENSE.txt*  public&#x2F;  README.md*  runtime&#x2F;  test.php*  think*  thinkphp&#x2F;  tmp&#x2F;  vendor&#x2F;</span><br></pre></td></tr></table></figure>\n<p>é‡å¯nginxå’Œphp-fpmï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl restart php73-fpm</span><br><span class=\"line\">systemctl restart nginx.service</span><br></pre></td></tr></table></figure>\n<p>èƒ½è®¿é—®http://127.0.0.1/public/index.phpè¯´æ˜nginx+php7.3é…ç½®çš„æ²¡é—®é¢˜ï¼š</p>\n<p><img src=\"../static/images/image-20210309095347435.png\" alt=\"image-20210309095347435\" /></p>\n<p>åœ¨æ ¹ç›®å½•æ–°å»ºä¸ªtest.phpï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">phpinfo();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>èƒ½çœ‹åˆ°xdebugè¯´æ˜xdebugæ²¡å•¥é—®é¢˜ï¼š</p>\n<p><img src=\"../static/images/image-20210309095521032.png\" alt=\"image-20210309095521032\" /></p>\n<p>PHPStorméœ€è¦åŠ ä¸‰ä¸ªé…ç½®ï¼š</p>\n<p><img src=\"../static/images/image-20210309095603856.png\" alt=\"image-20210309095603856\" /></p>\n<p><img src=\"../static/images/image-20210309095626043.png\" alt=\"image-20210309095626043\" /></p>\n<p><img src=\"../static/images/image-20210309095639471.png\" alt=\"image-20210309095639471\" /></p>\n<p>ä¾æ¬¡ç‚¹å¼€ï¼š</p>\n<p><img src=\"../static/images/image-20210309095822596.png\" alt=\"image-20210309095822596\" /></p>\n<p>åŸºæœ¬éƒ½æ˜¯å¯¹çš„å°±æ²¡å•¥é—®é¢˜ï¼ˆ9003é‚£ä¸ªä¸ç”¨ç®¡ä»–ï¼Œç„¶åæœ‰å…¶ä»–æŠ¥é”™æ ¹æ®æç¤ºæ”¹å°±æ˜¯äº†ï¼Œæˆ‘ç´¯äº†ï¼‰ï¼š</p>\n<p><img src=\"../static/images/image-20210309095900514.png\" alt=\"image-20210309095900514\" /></p>\n<p>ç„¶åè¿™ä¸¤ä¸ªå„å¼€ä¸€ä¸‹debugå°±è¡Œäº†ï¼š</p>\n<p><img src=\"../static/images/image-20210309095929909.png\" alt=\"image-20210309095929909\" /></p>\n<h1 id=\"æœªå¼€å¯å¼ºåˆ¶è·¯ç”±å¯¼è‡´rce\"><a class=\"markdownIt-Anchor\" href=\"#æœªå¼€å¯å¼ºåˆ¶è·¯ç”±å¯¼è‡´rce\"></a> æœªå¼€å¯å¼ºåˆ¶è·¯ç”±å¯¼è‡´rce</h1>\n<p>5.0.x payloadï¼š</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?s&#x3D;index&#x2F;\\think\\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;id</span><br><span class=\"line\">?s&#x3D;index&#x2F;think\\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;whoami</span><br></pre></td></tr></table></figure>\n<p>5.0.xä¸5.1.x payloadä¸åŒï¼Œæœ¬ç« åªåˆ†æ5.0.22ç‰ˆæœ¬å¯¹åº”çš„æºç ã€‚</p>\n<p>ä»<a href=\"https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815\">ä¿®å¤</a>çœ‹é€ æˆæ¼æ´å¤„ï¼š</p>\n<p><img src=\"../static/images/image-20210309104235268.png\" alt=\"image-20210309104235268\" /></p>\n<p>å³/Index/think\\app/invokefunctionä¸­çš„think\\appéƒ¨åˆ†ï¼Œå¿…é¡»ä¸ºï¼š</p>\n<p>å­—æ¯å¼€å¤´ ä¸” åˆ°æœ«å°¾å¿…é¡»éƒ½ä¸ºæ•°å­—å­—æ¯ï¼ŒæŠŠ&quot;\\â€œç»™è¿‡æ»¤æ‰äº†ï¼Œthink\\appå› ä¸ºåŒ…å«â€\\&quot;ï¼Œå› æ­¤åœ¨åç»­ç‰ˆæœ¬ä¸­ä¼šæŠ¥é”™ã€‚</p>\n<p>é‚£ä¹ˆåˆ†ææ¼æ´å…³é”®çš„éƒ¨åˆ†å°±æ˜¯æ€ä¹ˆè§£æ&quot;\\&quot;è¿™é‡Œã€‚</p>\n<p>åœ¨thinkphp-&gt;library-&gt;think-&gt;APP.php ç¬¬553è¡Œæ‰“æ–­ç‚¹ï¼š</p>\n<p><img src=\"../static/images/image-20210309101330291.png\" alt=\"image-20210309101330291\" /></p>\n<p>æ ¹æ®553ï¼Œ557è¡Œä»¥åŠ$resultæ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“index/think\\app/invokefunctionåˆ†åˆ«å¯ä»¥æŒ‡å®šï¼š</p>\n<p>æ§åˆ¶å™¨ $controller ä¸º think\\app</p>\n<p>æ“ä½œå $actionName ä¸º invokefunction</p>\n<p>565è¡Œï¼Œæ ¹æ®$controllerå’Œ$actionNameï¼Œè®¾ç½®å½“å‰è¯·æ±‚çš„æ“ä½œå™¨ï¼š</p>\n<p><img src=\"../static/images/image-20210309102136758.png\" alt=\"image-20210309102136758\" /></p>\n<p><img src=\"../static/images/image-20210309102153169.png\" alt=\"image-20210309102153169\" /></p>\n<p>å‰é¢éƒ½æ˜¯è®¾ç½®ä¸€äº›å‚æ•°çš„ï¼Œ571è¡Œè¿™é‡Œè·Ÿä¸€ä¸‹Loader::controllerï¼ŒLoader.phpçš„476è¡Œä¸­æœ‰ä¸ªgetModuleAndClasså‡½æ•°ï¼š</p>\n<p><img src=\"../static/images/image-20210309112648259.png\" alt=\"image-20210309112648259\" /></p>\n<p>479è¡Œè¿™é‡Œæœ‰ä¸ªinvokeClassï¼š</p>\n<p><img src=\"../static/images/image-20210309113148298.png\" alt=\"image-20210309113148298\" /></p>\n<p>è·Ÿè¿›å»ï¼Œå‘ç°å…¶å†…å®¹æ˜¯ä¸€ä¸ªåå°„ç±»çš„è¿‡ç¨‹ï¼Œè¿™é‡ŒæŠŠæˆ‘ä»¬æŒ‡å®šçš„classï¼Œä¹Ÿå°±æ˜¯think\\appæŒ‡å®šçš„ç±»ï¼Œä¼ ç»™äº†$constructorï¼š</p>\n<p><img src=\"../static/images/image-20210309113648190.png\" alt=\"image-20210309113648190\" /></p>\n<p>åå°„å¯å‚è€ƒ<a href=\"https://www.php.net/manual/zh/class.reflectionclass.php\">å®˜æ–¹æ‰‹å†Œ</a>ï¼Œæœ€åè¿”å›åˆ°APP.phpè¿™é‡Œï¼Œ$instanceå°±å˜æˆäº†think\\appçš„å®ä¾‹åŒ–ï¼š</p>\n<p><img src=\"../static/images/image-20210309114205321.png\" alt=\"image-20210309114205321\" /></p>\n<p>ä¸€è·¯è·Ÿåˆ°APP.phpç¬¬606è¡Œï¼Œè·ŸéšinvokeMethodå‡½æ•°ï¼Œç„¶åè·ŸéšbindParamså‡½æ•°ï¼š</p>\n<p><img src=\"../static/images/image-20210309114944995.png\" alt=\"image-20210309114944995\" /></p>\n<p>å¦‚æœå‚æ•°ä¸ºç©ºï¼Œé‚£ä¹ˆå°±ä¼šæ ¹æ®è·¯ç”±æ¥è·å–å‚æ•°ï¼Œå…¶ä¸­ä¼šè¿‡æ»¤ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œæ³¨æ„ä¸€ä¸‹ï¼š</p>\n<p><img src=\"../static/images/image-20210309115346300.png\" alt=\"image-20210309115346300\" /></p>\n<p>ç„¶åæ ¹æ®æˆ‘ä»¬è¾“å…¥çš„å‚æ•°åï¼Œå€¼ä½œä¸ºè¿”å›å€¼ï¼Œå¯¹åº”function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=idï¼š</p>\n<p><img src=\"../static/images/image-20210309115507308.png\" alt=\"image-20210309115507308\" /></p>\n<p>åˆ°InvokeArgè¿™é‡Œï¼š</p>\n<p><img src=\"../static/images/image-20210309120040834.png\" alt=\"image-20210309120040834\" /></p>\n<p>è¿™é‡Œå°±ä¼šæŠŠsystem å’Œ å‚æ•°ä½œä¸ºè¾“å…¥ç»§ç»­è°ƒç”¨ï¼Œæœ€åæ‰§è¡Œçš„ç»“æœä¼šè¿”å›åˆ°Responseä¸­ï¼š</p>\n<p><img src=\"../static/images/image-20210309115903673.png\" alt=\"image-20210309115903673\" /></p>\n<p>æµç¨‹æ€»ç»“ï¼š</p>\n<p>å½“thinkphpä»uriçš„å‚æ•°sä¸­æ¥å—åˆ°</p>\n<p>Index/think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=or</p>\n<p>æ—¶ï¼Œthink\\appä½œä¸ºclassï¼Œinvokefunctionä½œä¸ºreflect methodè¢«è°ƒç”¨ï¼Œ</p>\n<p>è€Œé»˜è®¤é…ç½®ä¸‹ï¼Œurl_param_type = 0æ—¶ï¼Œå…¶å°†ä»å‚æ•°ä¸­è·å–reflect methodçš„å‚æ•°</p>\n<p>systemä½œä¸ºinvokefunctionå‡½æ•°invokeçš„å‡½æ•°ï¼Œè€Œvars[]æ•°ç»„ä¸ºsystemå‡½æ•°çš„è¾“å…¥è¢«è°ƒç”¨ï¼Œå› æ­¤é€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚</p>\n<p>ä¿®å¤åï¼Œthinkphpä¸å…è®¸ä½¿ç”¨å¸¦åæ–œæ çš„ç±»æ¥å®šä¹‰ï¼Œé™åˆ¶äº†æ”»å‡»è€…åˆ©ç”¨é“¾è·¯ï¼Œå› æ­¤ä¿®è¡¥äº†è¯¥é—®é¢˜ã€‚</p>\n<h1 id=\"reference\"><a class=\"markdownIt-Anchor\" href=\"#reference\"></a> Reference</h1>\n<p>[1] <a href=\"https://www.php.net/manual/zh/class.reflectionclass.php\">https://www.php.net/manual/zh/class.reflectionclass.php</a></p>\n<p>[2] <a href=\"http://www.thinkphp.cn/download/1260.html\">http://www.thinkphp.cn/download/1260.html</a></p>\n<p>[3] <a href=\"https://blog.csdn.net/KSalomo/article/details/106055536\">https://blog.csdn.net/KSalomo/article/details/106055536</a></p>\n<p>[4] <a href=\"https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815\">https://github.com/top-think/framework/commit/802f284bec821a608e7543d91126abc5901b2815</a></p>\n<p>[5] <a href=\"https://xz.aliyun.com/t/3570#toc-0\">https://xz.aliyun.com/t/3570#toc-0</a></p>\n<p>[6] <a href=\"https://xz.aliyun.com/t/7792#toc-0\">https://xz.aliyun.com/t/7792#toc-0</a></p>\n","categories":[],"tags":[{"name":"æ¸—é€ RCE","slug":"æ¸—é€-RCE","count":2,"path":"api/tags/æ¸—é€-RCE.json"}]}